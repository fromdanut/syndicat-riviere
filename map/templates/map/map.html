{% extends 'base.html' %}
{% load static %}

{% block head %}

<!-- CDN : CSS for leafLet  -->
	<link rel="stylesheet" href="https://npmcdn.com/leaflet@0.7.7/dist/leaflet.css" />
	 <!--[if lte IE 8]>
	     <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
	 <![endif]-->

<!-- specific CSS for pages with map -->
	<link href={% static "css/map.css" %} rel="stylesheet">

{% endblock %}

{% block section %}
<section class="col-sm-9">
	<h1 class="text-center">Carte du Bassin Versant de la rivière</h1>
	<div id="map"></div>
</section>

{% endblock %}

{% block extraJS %}

<!-- CDN : JS for leafLet  -->
<script src="https://npmcdn.com/leaflet@0.7.7/dist/leaflet.js"></script>

<!-- Specific script for the mapp APP -->
<script>

/* CREATE BASE MAP */

//create the map without the coordonates and zooming propriaties.
var myMap = L.map('map').setView([49.1653, 2.65], 11);

// sources of the map
var sources = { 'sourceCLC' : '<a href = "http://www.statistiques.developpement-durable.gouv.fr/donnees-ligne/li/1825.html">CorinLandCover</a> ',
		'sourceCDO_BV' : '<a href = "https://www.data.gouv.fr/fr/datasets/bd-carthage-onm/">BDCarthage</a>',
		'sourceSTEP_CAPTAGE' : '<a href = "http://www.seine-normandie.eaufrance.fr/">AESN</a>',
		'icone8' : '<a href = "https://icons8.com/">Icons8</a>',

	       };

var Sources = ' | ' + sources['icone8'] + ' | sources : ' +  sources['CLC'] + ', ' + sources['CDO_BV'] 			+ ', ' + sources['STEP_CAPTAGE'] 


// add a tiles from a API (here is osm).
var tiles = L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
	maxZoom: 18,
	attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'+ Sources 
});

tiles.addTo(myMap);

/* LOAD DATA FROM THE VIEW*/

//enables to load the variable from views to template
var dataBV = JSON.parse('{{ BV | escapejs }}');
var dataCDO = JSON.parse('{{ CDO | escapejs }}');
var dataCLC = JSON.parse('{{ CLC | escapejs }}');
var dataCAPTAGE = JSON.parse('{{ CAPTAGE | escapejs }}');
var dataSTEP = JSON.parse('{{ STEP | escapejs }}');


// set a variable that we will feed with *GeoJSON DATA*, *STYLE* and an *INTERACTION* function
var BV;
var CDO;
var CLC;

/* SET STYLES AND INTERACTION*/

// BV
var styleBV = 	{
	weight: 5,
	color: 'black',
	dashArray: '',
	fillOpacity: 0
}

// CDO

function getWeight(ordreCDO) {
	return ordreCDO === 1 ? 5 : // if ordre is 1 (e.g. big CDO)
				2 ; // else for smallest CDO
	}
	

function styleCDO(feature) {
	return {
	weight: getWeight(feature.properties.ordre),
	color: 'blue',
	opacity : 1,
	};
}

	/* INTERACTION : an event on mouse hover. It'll show some informations for each feature */

	//change style function :

	function highlightFeature(e) {
	    var layer = e.target;

	    layer.setStyle({
		weight: 5,
		color: 'grey',
	    });

	    if (!L.Browser.ie && !L.Browser.opera) {
		layer.bringToFront();
	    }

	    info.update(layer.feature.properties);// FOR THE CUSTOM CONTROL
	}

	// reset default style with 'resetStyle'

	function resetHighlight(e) {
	    CDO.resetStyle(e.target);
	    info.update(); // FOR THE CUSTOM CONTROL
	}
	    
	// group the 2 listeners to a single object

	function onEachFeature(feature, layer) {
	    layer.on({
		mouseover: highlightFeature,
		mouseout: resetHighlight
	    });
	}

// CLC

//A object with a color for each code_12 value

var CLCColors = {'1' : { 'code' : '#ea1a1a', 'legend' : 'ville'},
		 '2' : { 'code' : '#f2f2b5', 'legend' : 'agriculture'},
		 '3' : { 'code' : '#299019', 'legend' : 'forêt'}
		}

// a function to set the color in function of the rocktype via the rockTypeColors object

var styleCLC = function(feature) {
                return { color : CLCColors[feature.properties.code_12]['code'],
			 stroke : false,
			 fillOpacity : 0.7 };
	}

// STEP

var iconSTEP = L.icon({
    iconUrl: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAACKUlEQVRoge1ZPU7DMBj1EXqEHoEjcIQeIcJmYKIrLHTu1BvQhYUFJOxUokMiBqRObSWEhCq1R2Cy3STDx5JC2zht0sT5IpEnfVI2v/f9PP+EkAYNGlgDdWWHurKDzeMkOB60KJfflMtvx4MWNp/coEINmFDAhAIq1ACbTy6wF32+If8bL/ocm1dmMCGnCQFCTrF5ZQLjqpskHwdXXWx+B7EZ3DQBtR9oyuUwNft/IobYPI0wDm5KXIrwDJtvAowrL6sAxpWHzXcH1JWdzOQ3rVSnHZoKtcotQKgVNm9CyBHbPBIXQjuo5I/ZZgZHwrVVJmTvVPJbO3QPhXzR7KNXoZzsI1WhrOyjVeFCaKe87CM40im+f7QKVe0Lec48uaOKS0+WE2eBWRhaJe940LKW/TisDrON4a10mG22TyVtZLqs372t4fEzhKevEO7e1iWIsHj5Ny34/BXCeBnBeBnB42dYShUqFeAuol8B42VUbwGUy9n+Yg8f4Y6AW08XnYGZNQFMKH9/wcEk2BFwPw+KVsC3J8Bw+7p+1Yk2up8HcONpuBqdIMDm45cz0m3Tov339Y6A7cjrTs5It60JIMTcRkwoGM6DVBE53Mm3Sp6Qw4e5/vs60U65BFT1gr399m+aicEkgIePENxFBM8ZW6jyfwgmS62l86QhvlYWFkG5nKE+rRxqp9q1TRriwTa6U1rL1PKXkzPS7Xiz87fbK/72GVdd6z7foME/ww/Q6nx/rBx8SgAAAABJRU5ErkJggg==",
    iconAnchor: [0,0],
    iconSize:     [30, 30], // size of the icon
    popupAnchor:  [20, 0] // point from which the popup should open relative to the iconAnchor
});

/* ADD INFO : add a custom controle (using "control" object) to show information about CDO on mouse. */

	var info = L.control();

	info.onAdd = function (myMap) {
	    this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
	    this.update();
	    return this._div;
	};

	// method that we will use to update the control based on feature properties passed

	info.update = function (props) {
	    this._div.innerHTML = '<h4>Info sur les cours d\'eau</h4>' +  (props ?
		'<b>' + props.toponyme + '</b><br />' + 'Code hydro : ' + props.code_hydro
		: '<b>Survoler un cours d\'eau<b>');
	};

	info.addTo(myMap);


/* ADD DATA TO FINALIZE MAP */

// add each layers with its own style to the map

BV = L.geoJson(dataBV, { style : styleBV }).addTo(myMap);

CLC = L.geoJson(dataCLC, {style : styleCLC }).addTo(myMap);

CDO = L.geoJson(dataCDO, { style : styleCDO ,onEachFeature: onEachFeature}).addTo(myMap);

STEP = L.geoJson(dataSTEP, { // use pointToLayer function for point objects
    pointToLayer: function (feature, latlng) {
        return L.marker(latlng, {icon: iconSTEP}).bindPopup('<p>Step de : <b>' + feature.properties.step_nom + '</b></p>' + '<p>Taille de l\'agglo : <b>' + feature.properties.taille_agg + '</b></p>');
    }
});


CAPTAGE = L.geoJson(dataCAPTAGE, { // use pointToLayer function for point objects
    pointToLayer: function (feature, latlng) {
        return L.marker(latlng, {icon: iconSTEP});
    }
});

var overlayMaps = {
	    "Station d'épuration": STEP,
	    "Captage d'eau" : CAPTAGE
	};

// add a control layer for STEP objects, emtpy string is for the basemap (in our case there is only the OSM map tile).
L.control.layers('', overlayMaps, {position: 'bottomright', collapsed : false}).addTo(myMap); 

/* ADD CUSTOM LEGEND CONTROL for CLC features */

	var legend = L.control({position: 'bottomright'});

	legend.onAdd = function (myMap) {

		var div = L.DomUtil.create('div', 'info legend');
		
		// loop through CLCColors

		for (color in CLCColors) {
		    div.innerHTML +=
			 '<div><i style="background-color:' + CLCColors[color]['code'] + '"></i>' + '<p>' + CLCColors[color]['legend'] + '</p></div>';
		    }
		
		return div;
	};

	legend.addTo(myMap);

/* ADD A SCALE */

L.control.scale({position : 'bottomleft', imperial : false}).addTo(myMap);

/* ADD A SOURCE */


</script>
{% endblock %}
